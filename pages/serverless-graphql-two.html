<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Learn how YOU can build a Serverless GraphQL API on top of a Microservice architecture, part II</title>
    <meta name="description" content="[object Object]">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.ef35a4d2.css" as="style"><link rel="preload" href="/assets/js/app.db3c62db.js" as="script"><link rel="preload" href="/assets/js/9.454b5262.js" as="script"><link rel="preload" href="/assets/js/4.eac68367.js" as="script"><link rel="preload" href="/assets/js/197.72fc5f68.js" as="script"><link rel="prefetch" href="/assets/js/1.36663999.js"><link rel="prefetch" href="/assets/js/10.dd884694.js"><link rel="prefetch" href="/assets/js/100.d350c93e.js"><link rel="prefetch" href="/assets/js/101.a0f346f6.js"><link rel="prefetch" href="/assets/js/102.5aee7553.js"><link rel="prefetch" href="/assets/js/103.cd40300c.js"><link rel="prefetch" href="/assets/js/104.3f860f10.js"><link rel="prefetch" href="/assets/js/105.f8ebea5d.js"><link rel="prefetch" href="/assets/js/106.84577e76.js"><link rel="prefetch" href="/assets/js/107.27ac0460.js"><link rel="prefetch" href="/assets/js/108.2615d80d.js"><link rel="prefetch" href="/assets/js/109.a0275c41.js"><link rel="prefetch" href="/assets/js/11.e44a9c79.js"><link rel="prefetch" href="/assets/js/110.e0b89e24.js"><link rel="prefetch" href="/assets/js/111.85c1f355.js"><link rel="prefetch" href="/assets/js/112.83b57936.js"><link rel="prefetch" href="/assets/js/113.30083b82.js"><link rel="prefetch" href="/assets/js/114.2dcc568f.js"><link rel="prefetch" href="/assets/js/115.2ee55351.js"><link rel="prefetch" href="/assets/js/116.7f8fe402.js"><link rel="prefetch" href="/assets/js/117.ca8b3931.js"><link rel="prefetch" href="/assets/js/118.8bd003cb.js"><link rel="prefetch" href="/assets/js/119.d1d06b3e.js"><link rel="prefetch" href="/assets/js/12.e184416b.js"><link rel="prefetch" href="/assets/js/120.dab30e46.js"><link rel="prefetch" href="/assets/js/121.9d3257d5.js"><link rel="prefetch" href="/assets/js/122.21f57fef.js"><link rel="prefetch" href="/assets/js/123.826f7c41.js"><link rel="prefetch" href="/assets/js/124.c134f35c.js"><link rel="prefetch" href="/assets/js/125.88e1d9ef.js"><link rel="prefetch" href="/assets/js/126.1d33b1c8.js"><link rel="prefetch" href="/assets/js/127.882b658e.js"><link rel="prefetch" href="/assets/js/128.4387dd5e.js"><link rel="prefetch" href="/assets/js/129.350431a1.js"><link rel="prefetch" href="/assets/js/13.215ad842.js"><link rel="prefetch" href="/assets/js/130.62aa76ba.js"><link rel="prefetch" href="/assets/js/131.4a9b4652.js"><link rel="prefetch" href="/assets/js/132.067ac058.js"><link rel="prefetch" href="/assets/js/133.f925bfac.js"><link rel="prefetch" href="/assets/js/134.4b3c8ed1.js"><link rel="prefetch" href="/assets/js/135.96f53f83.js"><link rel="prefetch" href="/assets/js/136.8bd779e9.js"><link rel="prefetch" href="/assets/js/137.71cefa4d.js"><link rel="prefetch" href="/assets/js/138.3cb402cc.js"><link rel="prefetch" href="/assets/js/139.0480e428.js"><link rel="prefetch" href="/assets/js/14.1a060010.js"><link rel="prefetch" href="/assets/js/140.afa32967.js"><link rel="prefetch" href="/assets/js/141.03aaff81.js"><link rel="prefetch" href="/assets/js/142.d2c0dd55.js"><link rel="prefetch" href="/assets/js/143.3db9c299.js"><link rel="prefetch" href="/assets/js/144.7775d6c9.js"><link rel="prefetch" href="/assets/js/145.750f54ca.js"><link rel="prefetch" href="/assets/js/146.ce90e1b5.js"><link rel="prefetch" href="/assets/js/147.bb809de9.js"><link rel="prefetch" href="/assets/js/148.9c076f3a.js"><link rel="prefetch" href="/assets/js/149.70062715.js"><link rel="prefetch" href="/assets/js/15.34674cd6.js"><link rel="prefetch" href="/assets/js/150.3eb04a33.js"><link rel="prefetch" href="/assets/js/151.9c7af9fc.js"><link rel="prefetch" href="/assets/js/152.86614e8d.js"><link rel="prefetch" href="/assets/js/153.96a63cd3.js"><link rel="prefetch" href="/assets/js/154.b3f1f8dc.js"><link rel="prefetch" href="/assets/js/155.856f98be.js"><link rel="prefetch" href="/assets/js/156.3b2b9b5f.js"><link rel="prefetch" href="/assets/js/157.71fb8687.js"><link rel="prefetch" href="/assets/js/158.516c87fc.js"><link rel="prefetch" href="/assets/js/159.52b7d653.js"><link rel="prefetch" href="/assets/js/16.119e91d4.js"><link rel="prefetch" href="/assets/js/160.9ab8d57c.js"><link rel="prefetch" href="/assets/js/161.8b79f713.js"><link rel="prefetch" href="/assets/js/162.f321f983.js"><link rel="prefetch" href="/assets/js/163.f427055c.js"><link rel="prefetch" href="/assets/js/164.011a4165.js"><link rel="prefetch" href="/assets/js/165.fb04e357.js"><link rel="prefetch" href="/assets/js/166.22aa118b.js"><link rel="prefetch" href="/assets/js/167.9b3a7654.js"><link rel="prefetch" href="/assets/js/168.809a29e6.js"><link rel="prefetch" href="/assets/js/169.5ad4e8f0.js"><link rel="prefetch" href="/assets/js/17.86bc7706.js"><link rel="prefetch" href="/assets/js/170.aec3fd57.js"><link rel="prefetch" href="/assets/js/171.32dbd986.js"><link rel="prefetch" href="/assets/js/172.601575f2.js"><link rel="prefetch" href="/assets/js/173.52dd154d.js"><link rel="prefetch" href="/assets/js/174.5ba6300a.js"><link rel="prefetch" href="/assets/js/175.2f89e69b.js"><link rel="prefetch" href="/assets/js/176.9dc0eac7.js"><link rel="prefetch" href="/assets/js/177.1c365624.js"><link rel="prefetch" href="/assets/js/178.91caba05.js"><link rel="prefetch" href="/assets/js/179.9c911a6e.js"><link rel="prefetch" href="/assets/js/18.cd87a72e.js"><link rel="prefetch" href="/assets/js/180.80655cbf.js"><link rel="prefetch" href="/assets/js/181.ed85d983.js"><link rel="prefetch" href="/assets/js/182.1e17fc78.js"><link rel="prefetch" href="/assets/js/183.02acffe6.js"><link rel="prefetch" href="/assets/js/184.9243297f.js"><link rel="prefetch" href="/assets/js/185.f8354684.js"><link rel="prefetch" href="/assets/js/186.d7462eed.js"><link rel="prefetch" href="/assets/js/187.26d2f0ca.js"><link rel="prefetch" href="/assets/js/188.5b1aa9be.js"><link rel="prefetch" href="/assets/js/189.d054804a.js"><link rel="prefetch" href="/assets/js/19.910fc8d0.js"><link rel="prefetch" href="/assets/js/190.c79e4c7b.js"><link rel="prefetch" href="/assets/js/191.190bbaf4.js"><link rel="prefetch" href="/assets/js/192.d0f08b9f.js"><link rel="prefetch" href="/assets/js/193.65076ebc.js"><link rel="prefetch" href="/assets/js/194.79a28f24.js"><link rel="prefetch" href="/assets/js/195.c3db4ae0.js"><link rel="prefetch" href="/assets/js/196.922f01f4.js"><link rel="prefetch" href="/assets/js/198.3e9c7e4c.js"><link rel="prefetch" href="/assets/js/199.7c704dea.js"><link rel="prefetch" href="/assets/js/20.f2e93d17.js"><link rel="prefetch" href="/assets/js/200.8746331d.js"><link rel="prefetch" href="/assets/js/201.4698882a.js"><link rel="prefetch" href="/assets/js/202.0a8a7594.js"><link rel="prefetch" href="/assets/js/203.64f9b437.js"><link rel="prefetch" href="/assets/js/204.d6f38f7a.js"><link rel="prefetch" href="/assets/js/205.7866d898.js"><link rel="prefetch" href="/assets/js/206.9b24367e.js"><link rel="prefetch" href="/assets/js/207.2fb62ef6.js"><link rel="prefetch" href="/assets/js/208.8a29c442.js"><link rel="prefetch" href="/assets/js/21.8afea724.js"><link rel="prefetch" href="/assets/js/22.16b7f426.js"><link rel="prefetch" href="/assets/js/23.b4e38d6f.js"><link rel="prefetch" href="/assets/js/24.d54f4334.js"><link rel="prefetch" href="/assets/js/25.2d1f0877.js"><link rel="prefetch" href="/assets/js/26.d1bfb1b7.js"><link rel="prefetch" href="/assets/js/27.0610f28c.js"><link rel="prefetch" href="/assets/js/28.f1b496e3.js"><link rel="prefetch" href="/assets/js/29.08e9944c.js"><link rel="prefetch" href="/assets/js/3.970a66a4.js"><link rel="prefetch" href="/assets/js/30.ae297928.js"><link rel="prefetch" href="/assets/js/31.4fd0d93b.js"><link rel="prefetch" href="/assets/js/32.44966b63.js"><link rel="prefetch" href="/assets/js/33.eb167d44.js"><link rel="prefetch" href="/assets/js/34.295422ff.js"><link rel="prefetch" href="/assets/js/35.2c5a0b70.js"><link rel="prefetch" href="/assets/js/36.fddd48a5.js"><link rel="prefetch" href="/assets/js/37.367a54b5.js"><link rel="prefetch" href="/assets/js/38.77ea2014.js"><link rel="prefetch" href="/assets/js/39.18b0acf7.js"><link rel="prefetch" href="/assets/js/40.ee22aa00.js"><link rel="prefetch" href="/assets/js/41.8b43745c.js"><link rel="prefetch" href="/assets/js/42.66bb07f8.js"><link rel="prefetch" href="/assets/js/43.636bf8a8.js"><link rel="prefetch" href="/assets/js/44.b341b996.js"><link rel="prefetch" href="/assets/js/45.d885e19e.js"><link rel="prefetch" href="/assets/js/46.7e4d0e2f.js"><link rel="prefetch" href="/assets/js/47.3bc4cde3.js"><link rel="prefetch" href="/assets/js/48.4ee9fba2.js"><link rel="prefetch" href="/assets/js/49.14783870.js"><link rel="prefetch" href="/assets/js/5.d1da013e.js"><link rel="prefetch" href="/assets/js/50.13c266ab.js"><link rel="prefetch" href="/assets/js/51.4318da19.js"><link rel="prefetch" href="/assets/js/52.7c9cc18f.js"><link rel="prefetch" href="/assets/js/53.378b5732.js"><link rel="prefetch" href="/assets/js/54.e47e03a7.js"><link rel="prefetch" href="/assets/js/55.ee80e16b.js"><link rel="prefetch" href="/assets/js/56.e14027f4.js"><link rel="prefetch" href="/assets/js/57.b3cb8ffb.js"><link rel="prefetch" href="/assets/js/58.eb09f34e.js"><link rel="prefetch" href="/assets/js/59.a537c130.js"><link rel="prefetch" href="/assets/js/6.9bdf2d86.js"><link rel="prefetch" href="/assets/js/60.25c48265.js"><link rel="prefetch" href="/assets/js/61.8653aa8c.js"><link rel="prefetch" href="/assets/js/62.69bb406d.js"><link rel="prefetch" href="/assets/js/63.4e7c77ba.js"><link rel="prefetch" href="/assets/js/64.ecda83e6.js"><link rel="prefetch" href="/assets/js/65.55a0ff6e.js"><link rel="prefetch" href="/assets/js/66.ed942689.js"><link rel="prefetch" href="/assets/js/67.6f7c9f8c.js"><link rel="prefetch" href="/assets/js/68.006a7e36.js"><link rel="prefetch" href="/assets/js/69.574000ec.js"><link rel="prefetch" href="/assets/js/7.9ac2367b.js"><link rel="prefetch" href="/assets/js/70.e3b758e6.js"><link rel="prefetch" href="/assets/js/71.4d8bdcb1.js"><link rel="prefetch" href="/assets/js/72.c2526cec.js"><link rel="prefetch" href="/assets/js/73.d791feee.js"><link rel="prefetch" href="/assets/js/74.5973a4fb.js"><link rel="prefetch" href="/assets/js/75.69a97303.js"><link rel="prefetch" href="/assets/js/76.6241dd05.js"><link rel="prefetch" href="/assets/js/77.cc95848f.js"><link rel="prefetch" href="/assets/js/78.bf5853c2.js"><link rel="prefetch" href="/assets/js/79.6ca3cd68.js"><link rel="prefetch" href="/assets/js/8.6b13a443.js"><link rel="prefetch" href="/assets/js/80.db3dafc8.js"><link rel="prefetch" href="/assets/js/81.c48160c5.js"><link rel="prefetch" href="/assets/js/82.8c1c51fe.js"><link rel="prefetch" href="/assets/js/83.76256fe7.js"><link rel="prefetch" href="/assets/js/84.ba6c380e.js"><link rel="prefetch" href="/assets/js/85.71c3233e.js"><link rel="prefetch" href="/assets/js/86.fe0ed2a2.js"><link rel="prefetch" href="/assets/js/87.d7dca667.js"><link rel="prefetch" href="/assets/js/88.d7051ae9.js"><link rel="prefetch" href="/assets/js/89.ceed231e.js"><link rel="prefetch" href="/assets/js/90.cb5b9f7e.js"><link rel="prefetch" href="/assets/js/91.186b87b4.js"><link rel="prefetch" href="/assets/js/92.09574fb8.js"><link rel="prefetch" href="/assets/js/93.d159420a.js"><link rel="prefetch" href="/assets/js/94.59ad6229.js"><link rel="prefetch" href="/assets/js/95.06d1a88d.js"><link rel="prefetch" href="/assets/js/96.8ac1aaf0.js"><link rel="prefetch" href="/assets/js/97.b6ad2632.js"><link rel="prefetch" href="/assets/js/98.9157217b.js"><link rel="prefetch" href="/assets/js/99.c25b229f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef35a4d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Learn how YOU can build a Serverless GraphQL API on top of a Microservice architecture, part II</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/serverless-graphql-two.html#the-plan" class="sidebar-link">The Plan</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/serverless-graphql-two.html#resources" class="sidebar-link">Resources</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/serverless-graphql-two.html#project-structure" class="sidebar-link">Project structure</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/serverless-graphql-two.html#create-a-serverless-function" class="sidebar-link">Create a serverless function</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#scaffold-a-project" class="sidebar-link">Scaffold a project</a></li><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#debug" class="sidebar-link">Debug</a></li></ul></li><li><a href="/pages/serverless-graphql-two.html#adding-the-graphql-api-to-our-serverless-app" class="sidebar-link">Adding the Graphql API to our Serverless app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#import-our-graphql-api" class="sidebar-link">Import our GraphQL API</a></li><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#call-the-graphql-api-from-our-serverless-function" class="sidebar-link">Call the Graphql API from our serverless function</a></li></ul></li><li><a href="/pages/serverless-graphql-two.html#deploy-our-app-to-azure" class="sidebar-link">Deploy our app to Azure</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#create-container-registry" class="sidebar-link">Create container registry</a></li><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#build-and-tag-images" class="sidebar-link">Build and tag Images</a></li><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#push-images-to-the-cloud" class="sidebar-link">Push images to the Cloud</a></li><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#create-service-endpoints" class="sidebar-link">Create service endpoints</a></li></ul></li><li><a href="/pages/serverless-graphql-two.html#deploy-the-serverless-app" class="sidebar-link">Deploy the Serverless app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/serverless-graphql-two.html#using-local-settings-json-over-env" class="sidebar-link">Using local.settings.json over .env</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p># Learn how YOU can build a Serverless GraphQL API on top of a Microservice</p> <p>Follow me on <a href="https://twitter.com/chris_noring" target="_blank" rel="noopener noreferrer">Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, happy to take your suggestions on topics or improvements /Chris</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/65simd8ue5l3n04hgmzi.jpg" alt=""></p> <blockquote><p>This is when we take our Microservices, our GraphQL API, host that in a Serverless app and bring it all to production. Yes, it's a 15 min read, but what you get for it is something you can build on for your own projects. It is worth the read and plenty of pictures on the way. I hope you stay with me 😃</p></blockquote> <p>This is part of series:</p> <ul><li><a href="https://dev.to/azure/learn-how-you-can-build-a-serverless-graphql-api-on-top-of-a-microservice-architecture-233g" target="_blank" rel="noopener noreferrer">Building Microservices and a GraphQL API, Part I<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Hosting the GraphQL API in a Serverless app and bring it all to the Cloud, part II, <strong>we are here</strong></li></ul> <p>This is the second part of our GraphQL, Serverless, Docker and Microservices series. Up to this point we have created Microservices, Dockerized those and was able to use the URL from those services when we stitched together our GraphQL API. That's an accomplishment in itself, however, we are not happy with that. We want to go to production - we want to go to the Cloud.</p> <p>I highly recommend reading the first part of the series, <a href="https://dev.to/azure/learn-how-you-can-build-a-serverless-graphql-api-on-top-of-a-microservice-architecture-233g" target="_blank" rel="noopener noreferrer">First part<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>If you have, let's rock !</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/i9fz44ky7tonla33mw6k.gif" alt=""></p> <h2 id="the-plan"><a href="#the-plan" aria-hidden="true" class="header-anchor">#</a> The Plan</h2> <p>We've mentioned the plan in part I. But here it is again</p> <ol><li><strong>Create</strong> microservices, part I</li> <li><strong>Dockerize</strong> services, part I</li> <li><strong>Create</strong> graphql api and have the resolve functions point to the url of each dockerized service, part I</li> <li><strong>Create</strong> a serverless function, <strong>this part</strong></li> <li><strong>Deploy</strong> the  our microservices to the Cloud, <strong>this part</strong></li> <li><strong>Add</strong> our graphql api to our serverless function, <strong>this part</strong></li> <li><strong>Deploy</strong> serverless function to the cloud, <strong>this part</strong></li></ol> <p>The first three items have been completed in the first part of our services, now it's time to tackle the remaining four items</p> <h2 id="resources"><a href="#resources" aria-hidden="true" class="header-anchor">#</a> Resources</h2> <p>You can definitely follow this guide without reading these links but learn more details on deploy options and how to build out Serverless or how to deploy your containers in Azure I recommend looking through these links:</p> <ul><li><a href="https://azure.microsoft.com/en-gb/free/?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">Free Azure Account<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> To be able to Deploy your services and host your Serverless function, you will need a free Azure account</li> <li><a href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-quickstart?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">Deploy a container to Azure<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
It's always good to see all the available options when deploying a container to Azure</li> <li><a href="https://dev.to/azure/all-your-containers-are-belong-to-usdeploying-to-microsoft-azure-7dm?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">All your containers are belong to us<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
An article I wrote on. Like the link above but explains a bit more</li> <li><a href="https://docs.microsoft.com/en-US/azure/azure-functions/functions-create-first-function-vs-code?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">Create and Deploy an Azure function in VS Code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
This shows how we can create an Azure Function in VS Code and deploy it to the Cloud</li> <li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function-azure-cli?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">Create an Azure function using the CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
The CLI is an excellent choice to create Azure functions with and also deploy with.</li> <li><a href="https://dev.to/softchris/5-part-docker-series-beginner-to-master-3m1b?wt.mc_id=academic-0000-chnoring" target="_blank" rel="noopener noreferrer">My 5 part series on Docker, if you need a Docker refresher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> This is a 5 part primer on Docker</li></ul> <h2 id="project-structure"><a href="#project-structure" aria-hidden="true" class="header-anchor">#</a> Project structure</h2> <p>Let's remind ourselves where we are with our project structure so we are on the same page moving forward. We should have the following:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/graphql-api
  /products  // our product service
  /reviews // our reviews service
  /serverless // will contain our serverless function
  docker-compose.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="create-a-serverless-function"><a href="#create-a-serverless-function" aria-hidden="true" class="header-anchor">#</a> Create a serverless function</h2> <p>To create our Function we first need a <code>Function app</code> to host it in. Before we get that far, let's ensure we've installed all the prerequisites we need. This looks a bit different on Mac and Windows. Let's start with Mac and open up a terminal and enter:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>brew tap azure/functions
brew install azure-functions-core-tools
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>If you are lacking <code>brew</code>, refer to this <a href="https://brew.sh/" target="_blank" rel="noopener noreferrer">link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to have it installed.</p> <p>For Windows we just need Node.js installed and then we open up a terminal and enter:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm install -g azure-functions-core-tools@2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We also need to install a Visual Studio Code extension to make scaffolding, debugging and deployment of our Azure function a breeze, so let's do that next. Click the extension's icon in VS Code and look for <code>Azure Functions</code> and select to install it.
<img src="https://thepracticaldev.s3.amazonaws.com/i/psz5ihp5kjyujpvq1qrq.png" alt=""></p> <h3 id="scaffold-a-project"><a href="#scaffold-a-project" aria-hidden="true" class="header-anchor">#</a> Scaffold a project</h3> <p>Our next step is to create an Azure App, we do so by pressing <code>COMMAND + SHIFT + P</code> or <code>CTRL+SHIFT+P</code> for Windows. This should bring up a menu looking like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/whmkarb5duxry8b4er1u.png" alt=""></p> <p>Thereafter you select the indicated command above and you are now presented with the following below.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/0v0iq5ul9x35rn09mkoo.png" alt=""></p> <p>You can select whatever folder you want but know that it will create a folder <code>.vscode</code> in the workspace you are currently in. <code>.vscode</code> contains a bunch of files making debugging of this project possible. I select the <code>serverless</code> folder and I also ensure VS Code has opened that folder so that my <code>.vscode</code> folder is created in the right place.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/zcj2e414fd0npniv57db.png" alt=""></p> <p>We go with <code>Javascript</code> this time. Next screen is to choose a trigger, that is, what event will lead to this code to be executed:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/0razhjgzwkmqy5y4mrji.png" alt=""></p> <p>Next step is giving the Azure function a name. Yes, it not only creates an Azure app project for us but it also creates one function that it starts out with. We can always add more functions later if we wish.</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/8qz3rkncd0x57ixx163m.png" alt=""></p> <p>I choose the name <code>graphql</code>. There, just one more step, <code>Authorization level</code>. There are three ways to authorize the usage of our app, <code>Anonymous</code>, <code>Function</code> and <code>Admin</code>. With <code>Anonymous</code> anyone can call our API and we don't need to send any extra credentials. With <code>Function</code> we need to send a function key as a header and with <code>Admin</code> it's even more things we need to do, to be able to be allowed to call the function. We settle for the option <code>Anonymous</code> as we, for now, want to make this easier to test. We should definitely revisit this choice as we progress building out our app. If it's a toy app <code>Anonymous</code> is fine but in a production scenario, you probably want to have <code>Function</code> or <code>Admin</code> as options.</p> <p>At this point you should have the following project structure:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/i8bavjo6xnah20euhaxk.png" alt=""></p> <h3 id="debug"><a href="#debug" aria-hidden="true" class="header-anchor">#</a> Debug</h3> <p>Let's make sure that our serverless function is correctly created by trying to debug it. Place a breakpoint in your <code>index.js</code> file like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/u67t6u62bmcdwxi6lgur.png" alt=""></p> <p>and now let's go the <code>Debug</code> menu, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/srwrabrnwj7qmtqq5f7x.png" alt=""></p> <p>This should start up the function and write a lot of things to the terminal and it should end with a URL printout looking like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/pmma69eje43anl2zl6vk.png" alt=""></p> <p>So we go and visit the indicated URL <code>http://localhost:7071/api/graphql</code> in a browser and this should lead to our breakpoint being hit:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/7ilotme17k7zntd86xei.png" alt=""></p> <p>Good, everything is working. We can now go to the next step, which is to take our Graphql API implementation and call it from our serverless function.</p> <h2 id="adding-the-graphql-api-to-our-serverless-app"><a href="#adding-the-graphql-api-to-our-serverless-app" aria-hidden="true" class="header-anchor">#</a> Adding the Graphql API to our Serverless app</h2> <p>Ok, add this point we need to make our created GraphQL part of our serverless app. To make that happen we need to move some files. We need to copy in the <code>package.json</code> file to the root of our serverless function project. When we create a project using VS Code it will run <code>npm install</code> for us, providing it finds a <code>package.json</code> at the right level. The rest of the GraphQL API we can easily copy in as a subdirectory under our <code>serverless</code> directory. It should now look like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/f6c1avcge3q464fru2mi.png" alt="">
As you can see above our GraphQL API directory <code>api</code> has been copied in and it now only consists of the files <code>app.js</code>, <code>raw-schema.js</code> and <code>services.js</code>. We have moved <code>package.json</code> and the <code>.env</code> file to the root of the serverless project.</p> <h3 id="import-our-graphql-api"><a href="#import-our-graphql-api" aria-hidden="true" class="header-anchor">#</a> Import our GraphQL API</h3> <p>At this point, we can start importing and calling the GraphQL code from our Serverless function. Let's open the <code>graphql</code> directory, where our function lives and open up <code>index.js</code> and start adding an import statement to our GraphQL API, like so:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// /graphql/index.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> graphql<span class="token punctuation">,</span> schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// the rest omitted for brevity</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The above means we are importing a file <code>../api.index.js</code>. We didn't create one in the past so we need to do that:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ../api.index.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>
  graphql
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'graphql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rawSchema <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./raw-schema'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  schema<span class="token punctuation">:</span> rawSchema<span class="token punctuation">,</span>
  graphql
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="call-the-graphql-api-from-our-serverless-function"><a href="#call-the-graphql-api-from-our-serverless-function" aria-hidden="true" class="header-anchor">#</a> Call the Graphql API from our serverless function</h3> <p>What now, how do we want to call our Serverless function? Well, we want to read a GraphQL query from either a query parameter our from the body.</p> <p>Before we come that far let's ensure we can spin up our Serverless function, call our GraphQL API with a static query and get some result. So change the content of <code>serverless/graphql/index.js</code> to the following:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> graphql<span class="token punctuation">,</span> schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../api'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JavaScript HTTP trigger function processed a request.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token string">`{ hello products { name, description } reviews { title, comment, grade, product { name, description } } }`</span></span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">graphql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        schema<span class="token punctuation">,</span>
        source<span class="token punctuation">:</span> query
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// status: 200, /* Defaults to 200 */</span>
        body<span class="token punctuation">:</span> result
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Let's ensure we have done the following before we proceed to test our implementation:</p> <ol><li>Ran <code>npm install</code>, we need to ensure we have installed, <code>graphql</code>, <code>dotenv</code>, <code>node-fetch</code></li> <li><strong>Ran</strong> <code>docker-compose up -d</code>, we need to spin up our services that our GraphQL API queries</li> <li><strong>Add code</strong> calling the GraphQL API</li> <li><strong>Debug</strong> Serverless function</li></ol> <p>When we've done steps 1-4 we are ready to debug. So let's select <code>Debug/ Start Debugging</code></p> <p>At this point we have something that we can test locally, so let's do just that:</p> <p><img src="serverless-browser-result.png" alt=""></p> <p>Ok, we can see it seems to work. Now that the time has come to prepare for deploy.</p> <h2 id="deploy-our-app-to-azure"><a href="#deploy-our-app-to-azure" aria-hidden="true" class="header-anchor">#</a> Deploy our app to Azure</h2> <p>Looking at it from a higher level there are some things we need to do. Our solution consists of two major parts, our microservices and our Serverless app that calls a GraphQL API. For our deployment to Cloud to work we need to deploy those parts separately. Let's list what we need to do and why:</p> <p>## Deploy the microservices to the Cloud
The microservices needs to be created as service endpoints. Because we are already using Docker lets leverage that and continue using Docker but in the cloud. How do you ask? This is how:</p> <ol><li><strong>Build</strong> the Docker images locally</li> <li><strong>Create</strong> a container registry in the Cloud, we will push our images to this registry. The reason is that our Container Registry is able to hold the images as a repository but it is also able to create containers from those images, provided they are inside the registry. Once we create containers from those images this will create service endpoints. Each service endpoint will receive a unique URL. We can use those URLs we get from the Cloud and have our Serverless/GraphQL solution point to those URLs instead of our local URLs</li> <li><strong>Tag images</strong>, before we can push each Docker image to our container registry in the Cloud we need to tag it with credentials from the Container registry. Then it's a simple push command to make the images end up in the registry.</li> <li><strong>Create service endpoints</strong>, when the Docker images are in our registry in the Cloud it's really simple to create containers from them, this will create service endpoints with a real URL, one for each service. We want the Serverless app and its GraphQL API to point to those endpoints</li></ol> <h3 id="create-container-registry"><a href="#create-container-registry" aria-hidden="true" class="header-anchor">#</a> Create container registry</h3> <p>We might need a resource group first if we don't have one we want to use for this. I recommend having a specific resource group for everything that goes together, web apps, services, accounts, etc. Here is the syntax for creating a <code>Resource Group</code> from the terminal:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az group create --name [name of resource group] --location westeurope
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>At this point you are ready to create the container registry:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr create --resource-group [name of resource group] --name [name of container registry, unique and only a-z or 0-9] --sku Basic --admin-enabled true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The above will create a container registry, using your existing resource group and it will also give your container registry a name and a price tier <code>Basic</code>.</p> <h3 id="build-and-tag-images"><a href="#build-and-tag-images" aria-hidden="true" class="header-anchor">#</a> Build and tag Images</h3> <p>Building images id a simple as running a Docker command. We do this twice, once for each service. We can either place ourselves in each service directory, where the Dockerfile is or we need to specify for each image creation where each of the Dockerfiles is located. We do the former, that is place ourselves in each Dockerfile containing directory:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// in /products

docker build -t products-service .

// in /reviews

docker build -t reviews-service .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Above we are giving it the name <code>product-service</code> and <code>reviews-service</code> respectively. At this point, we are ready to tag the images, so our container registry recognizes them. To do so we need a piece of information from the container registry that we need to tag our image with. The information we are looking for is called the <code>loginServer</code>. There are two ways we can come by this information, both ways work:</p> <ol><li>Log in to the container registry and query for that property</li> <li>Create it by merging the container registry name with a preset domain</li></ol> <p>Let's do 1) first:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr login --name [name of registry]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>This will log us into the registry and we are ready to query it for the information we need:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr show --name [name of container registry] --query loginServer --output table
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Above we are actively querying for <code>loginServer</code> and the result of this is our <code>loginServer</code>.</p> <p>The second option 2) is realizing we can guess this information by merging <code>[name of registry].azurecr.io</code>. As the domain might differ in the future I would say querying for <code>loginServer</code> is the more future safe way of doing it.</p> <p><strong>Tag the images</strong></p> <p>Ok, time to tag our images:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker tag products-service [loginServer]/products-service:v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>and then one more time for the other service:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker tag reviews-service [loginServer]/reviews-service:v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="push-images-to-the-cloud"><a href="#push-images-to-the-cloud" aria-hidden="true" class="header-anchor">#</a> Push images to the Cloud</h3> <p>Ok, finally we are ready to push the images to the container registry. This is as easy as typing:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker push [loginServer]/products-service:v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>and now for the <code>review-service</code>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker push [loginServer]/reviews-service:v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>I'm not gonna lie, this takes time if you sit at home. At least for me sitting on a connection that has fast download and slow upload. Try doing this step on a company WiFi, or good home WiFi at the least the first time. The next time you do it it will be fast it is able to cache some of the layers in the image. We can see that caching in action already when we push the <code>reviews-service</code> as they are very similar and uses the same image and other things:
<img src="https://thepracticaldev.s3.amazonaws.com/i/hkdqxenenysd6keihe3n.png" alt=""></p> <p><strong>Verify our upload</strong></p> <p>How do we know the images are actually in the registry, in our Cloud? We can query for them, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/03gybk1eq5ylsva5s9sd.png" alt=""></p> <p>Above we are running the command:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr repository list --name [name of registry] --output table
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>And the result is our <code>products-service</code> and our <code>reviews-service</code>. This is our images, but this time residing in the Cloud, in our container registry.</p> <h3 id="create-service-endpoints"><a href="#create-service-endpoints" aria-hidden="true" class="header-anchor">#</a> Create service endpoints</h3> <p>There are two ways of doing this:</p> <ol><li>We keep using the terminal and we run a command that creates a service endpoint/container for each image</li> <li>We use the Portal UI and select an App Service template that selects the right image</li></ol> <p><strong>The terminal</strong>
Yes, you can be using the Terminal here and below are the commands to make that happen. For this, especially as we are deploying for the first time I would recommend you use the alternate version, the Portal UI so you see visually what's going on.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr show --name --query loginServer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Then we get password and username</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az acr credential show --name --query &quot;passwords[0].value&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Then we finally push:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>az container create --resource-group [resource group] --name aci-tutorial-app --image &lt;acrLoginServer&gt;/[products-service or reviews-service]] --cpu 1 --memory 1 --registry-login-server [acrLoginServer] --registry-username [acrName] --registry-password [acrPassword] --dns-name-label [aciDnsLabel] --ports 80
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>The portal UI</strong>
This is the one that I use the most, I have to admit. I'm a creature of habit. We start with our usual create a resource button:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/m3u7ox70e1hnfcvfl269.png" alt=""></p> <p>Thereafter we need to choose a Web template that takes containers, this one:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/tbho3zfew4auk5789dot.png" alt=""></p> <p>Thereafter we need to fill in some mandatory fields:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/hv4tjrud8dhybgav21ld.png" alt="">
The <code>App name</code> needs to be globally unique. Select the <code>Subscription</code> you want should be billed. Select the existing <code>Resource Group</code> you've just created. Select the appropriate <code>App Service plan</code>. Lastly, click <code>Configure container</code>, now it's time to select the correct container registry and image we want to create a container from.</p> <p><img src="portal-container-config.png" alt=""> Here we are choosing the registry we created <code>chrisgraphqlregistry</code>, in your case, choose your created registry. Next up we choose the image <code>products-service</code>, followed by the tag <code>v1</code> and lastly we select our startup file <code>app.js</code>. Finally, we click <code>Apply</code> and this takes us back to our previous dialog and here we press <code>Create</code>. At this point, it provisions a service endpoint that when done will tell us the resulting URL.</p> <p>Once we click the provisioned resource, search for the <code>App name</code> you gave it. You should come to a screen like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/qvida8dim90zzdfe2opv.png" alt=""></p> <p>Now follow these exact instructions and do the same but create a service endpoint for the <code>reviews-service</code>.</p> <p>The first time you click either of the URL it takes a while, a so-called <em>cold start</em>. Once it's ready the result should look like this, for the <code>products-service</code>:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/kzb3jvuxe56mjub9r54g.png" alt=""></p> <p>and like this for the <code>reviews-service</code>:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/0so113c6w5t4x6wgmm6i.png" alt=""></p> <p>This means that we have successfully deployed our services and we are about 90% there. Wasn't too bad, was it? 😃</p> <h2 id="deploy-the-serverless-app"><a href="#deploy-the-serverless-app" aria-hidden="true" class="header-anchor">#</a> Deploy the Serverless app</h2> <p>Ok we need to do two things to deploy our serverless app:</p> <ol><li>Ensure the app reads its environment variables from the Cloud</li> <li>Deploy the app, using VS Code</li></ol> <h3 id="using-local-settings-json-over-env"><a href="#using-local-settings-json-over-env" aria-hidden="true" class="header-anchor">#</a> Using local.settings.json over .env</h3> <p>Right now we have the library <code>dotenv</code> read in environment variables from a <code>.env</code> file. This won't do when we are going to the Cloud. We need to read this from the <code>AppSettings</code> property of our Serverless app, once it is in the Cloud. The file <code>local.setting.json</code> can take its contents and copy itself into the AppSettings property so by populating that file we can ensure our environment variables end up in the Cloud.</p> <p>Now that we have deployed the services successfully to the Cloud let's create a file called <code>local.settings.json</code> in our Serverless app and have the content look like this with the service endpoint URLs filled in:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// local.settings.json

{
  &quot;IsEncrypted&quot;: false,
  &quot;Values&quot;: {
    &quot;PRODUCTS_URL&quot;: &quot;https://products-service-container.azurewebsites.net/&quot;,
    &quot;REVIEW_URL&quot;: &quot;https://reviews-service-container.azurewebsites.net/&quot;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>At this point we can go into <code>serverless/api/index.js</code> and remove the line that says:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>require('dotenv').config()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>cause now we are reading from <code>local.settings.json</code>. Now run the debugger. Go to your browser and it should still work at <code>http://localhost:7071/api/graphql</code>.</p> <p>### Deploying the Serverless app
This means we are ready for that final deploy step. Are you ready? Now I mean ready ready? Good, ok, let's do it 😃</p> <p>At this point, we need to interact with the <code>Azure view</code>. If you can't see it then take <code>View / Open View</code>, like so:
<img src="open-view.png" alt=""></p> <p>Then select to sign in to Azure, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/0485qfd86jawp4c9blx3.png" alt=""></p> <p>This will take you to a browser page that asks you to sign in. Once that is done, head back to VS Code and select the following:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/p07g5173lrpvuwuusvi0.png" alt=""></p> <p>Ok, at this point you are asked to select a subscription. After that, you come to this dialog
<img src="https://thepracticaldev.s3.amazonaws.com/i/feovtte58st3x1l1byez.png" alt="">.
Click to create a new Function app in the Azure.</p> <p>Lastly, you are asked to give the app a name. It needs to be globally unique. At this point, it will start to provision.
It will show something like this while we wait for it to finish:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/sx350ke8d6u820s8kycn.png" alt=""></p> <p>When done it will show you this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/7nis5z0xk4fcyv2y6dnm.png" alt=""></p> <p>Ok, let's click <code>View Output</code>:</p> <p>The first time you look at this the output might state that it has no knowledge of <code>PRODUCTS_URL</code> and <code>REVIEWS_URL</code> but we can fix that in our Azure menu, like so:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/yw4d7m5d02nneh1a4ro3.png" alt=""></p> <p>After that. Head to the portal again. Click <code>get function URL</code>:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/rbighlc06hrcsm35piha.png" alt="">
and this time you should see this in the browser:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/8ef5wfhx2pet77w1eaur.png" alt=""></p> <p>We did it. We deployed the services to the Cloud, we deployed the serverless app.</p> <p><strong>Final touch</strong></p> <p>Right now we are hardcoding what the query is that we send to our GraphQL API, so let's fix that and redeploy. The code should look like this now:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// serverless/graphql/index.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> graphql<span class="token punctuation">,</span> schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../api'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Products url'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PRODUCTS_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Reviews url'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REVIEW_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    context<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JavaScript HTTP trigger function processed a request.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> <span class="token string">&quot;You must send `query` as a query parameter or in the body&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">graphql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        schema<span class="token punctuation">,</span>
        source<span class="token punctuation">:</span> query
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// status: 200, /* Defaults to 200 */</span>
        body<span class="token punctuation">:</span> result
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>Now, redeploy
<img src="https://thepracticaldev.s3.amazonaws.com/i/zzz3vdn3cz1kvjv8ffsz.png" alt=""></p> <p>It should look like this:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/s9qhcfgjogu6q277utav.png" alt=""></p> <p>Ok, it seems to be working, it fails if it doesn't get a query param. Let's give it one <code>query</code> and let's assign it with the query <code>{ reviews { grade, product { name } } }</code></p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/lrjszjqshix6yoyg949y.png" alt=""></p> <p>## Summary</p> <p>There we have it, boys and girls. A working Serverless/GRaphQL API that talks to Microservices, also in the Cloud. How excited are you? I'm this excited:</p> <p><img src="https://thepracticaldev.s3.amazonaws.com/i/wcbuqieaaeln403ou7sn.gif" alt=""></p> <p>We started off with separate microservices. Dockerized those and ensured each service could be reachable through a URL. At that point, we started building a GraphQL API and started querying those services as a way to stitch together data which is one of the advantages of GraphQL to be that API on top of many other APIs.</p> <p>In this part, we went and put those services in the Cloud. We also created a Serverless App and pulled in our GraphQL API, that was also sent to the Cloud and suddenly everything is in the Cloud and can be maintained and redeployed separately. We are set up in a great way to expand our GraphQL API and we are really using the advantage of Serverless, we focus on writing code and ensure that we don't pay for more than we use.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.db3c62db.js" defer></script><script src="/assets/js/9.454b5262.js" defer></script><script src="/assets/js/4.eac68367.js" defer></script><script src="/assets/js/197.72fc5f68.js" defer></script>
  </body>
</html>
