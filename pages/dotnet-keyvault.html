<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Azure Key Vault to manage your secrets</title>
    <meta name="description" content="Azure Key Vault service is the recommended way to manage your secrets regardless of platform (e.g Node.js, .NET, Python etc). This article takes you through why Key Vault and how to work with it in local development as well as when your app is deployed on Azure.">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.ef35a4d2.css" as="style"><link rel="preload" href="/assets/js/app.db3c62db.js" as="script"><link rel="preload" href="/assets/js/9.454b5262.js" as="script"><link rel="preload" href="/assets/js/4.eac68367.js" as="script"><link rel="preload" href="/assets/js/156.3b2b9b5f.js" as="script"><link rel="prefetch" href="/assets/js/1.36663999.js"><link rel="prefetch" href="/assets/js/10.dd884694.js"><link rel="prefetch" href="/assets/js/100.d350c93e.js"><link rel="prefetch" href="/assets/js/101.a0f346f6.js"><link rel="prefetch" href="/assets/js/102.5aee7553.js"><link rel="prefetch" href="/assets/js/103.cd40300c.js"><link rel="prefetch" href="/assets/js/104.3f860f10.js"><link rel="prefetch" href="/assets/js/105.f8ebea5d.js"><link rel="prefetch" href="/assets/js/106.84577e76.js"><link rel="prefetch" href="/assets/js/107.27ac0460.js"><link rel="prefetch" href="/assets/js/108.2615d80d.js"><link rel="prefetch" href="/assets/js/109.a0275c41.js"><link rel="prefetch" href="/assets/js/11.e44a9c79.js"><link rel="prefetch" href="/assets/js/110.e0b89e24.js"><link rel="prefetch" href="/assets/js/111.85c1f355.js"><link rel="prefetch" href="/assets/js/112.83b57936.js"><link rel="prefetch" href="/assets/js/113.30083b82.js"><link rel="prefetch" href="/assets/js/114.2dcc568f.js"><link rel="prefetch" href="/assets/js/115.2ee55351.js"><link rel="prefetch" href="/assets/js/116.7f8fe402.js"><link rel="prefetch" href="/assets/js/117.ca8b3931.js"><link rel="prefetch" href="/assets/js/118.8bd003cb.js"><link rel="prefetch" href="/assets/js/119.d1d06b3e.js"><link rel="prefetch" href="/assets/js/12.e184416b.js"><link rel="prefetch" href="/assets/js/120.dab30e46.js"><link rel="prefetch" href="/assets/js/121.9d3257d5.js"><link rel="prefetch" href="/assets/js/122.21f57fef.js"><link rel="prefetch" href="/assets/js/123.826f7c41.js"><link rel="prefetch" href="/assets/js/124.c134f35c.js"><link rel="prefetch" href="/assets/js/125.88e1d9ef.js"><link rel="prefetch" href="/assets/js/126.1d33b1c8.js"><link rel="prefetch" href="/assets/js/127.882b658e.js"><link rel="prefetch" href="/assets/js/128.4387dd5e.js"><link rel="prefetch" href="/assets/js/129.350431a1.js"><link rel="prefetch" href="/assets/js/13.215ad842.js"><link rel="prefetch" href="/assets/js/130.62aa76ba.js"><link rel="prefetch" href="/assets/js/131.4a9b4652.js"><link rel="prefetch" href="/assets/js/132.067ac058.js"><link rel="prefetch" href="/assets/js/133.f925bfac.js"><link rel="prefetch" href="/assets/js/134.4b3c8ed1.js"><link rel="prefetch" href="/assets/js/135.96f53f83.js"><link rel="prefetch" href="/assets/js/136.8bd779e9.js"><link rel="prefetch" href="/assets/js/137.71cefa4d.js"><link rel="prefetch" href="/assets/js/138.3cb402cc.js"><link rel="prefetch" href="/assets/js/139.0480e428.js"><link rel="prefetch" href="/assets/js/14.1a060010.js"><link rel="prefetch" href="/assets/js/140.afa32967.js"><link rel="prefetch" href="/assets/js/141.03aaff81.js"><link rel="prefetch" href="/assets/js/142.d2c0dd55.js"><link rel="prefetch" href="/assets/js/143.3db9c299.js"><link rel="prefetch" href="/assets/js/144.7775d6c9.js"><link rel="prefetch" href="/assets/js/145.750f54ca.js"><link rel="prefetch" href="/assets/js/146.ce90e1b5.js"><link rel="prefetch" href="/assets/js/147.bb809de9.js"><link rel="prefetch" href="/assets/js/148.9c076f3a.js"><link rel="prefetch" href="/assets/js/149.70062715.js"><link rel="prefetch" href="/assets/js/15.34674cd6.js"><link rel="prefetch" href="/assets/js/150.3eb04a33.js"><link rel="prefetch" href="/assets/js/151.9c7af9fc.js"><link rel="prefetch" href="/assets/js/152.86614e8d.js"><link rel="prefetch" href="/assets/js/153.96a63cd3.js"><link rel="prefetch" href="/assets/js/154.b3f1f8dc.js"><link rel="prefetch" href="/assets/js/155.856f98be.js"><link rel="prefetch" href="/assets/js/157.71fb8687.js"><link rel="prefetch" href="/assets/js/158.516c87fc.js"><link rel="prefetch" href="/assets/js/159.52b7d653.js"><link rel="prefetch" href="/assets/js/16.119e91d4.js"><link rel="prefetch" href="/assets/js/160.9ab8d57c.js"><link rel="prefetch" href="/assets/js/161.8b79f713.js"><link rel="prefetch" href="/assets/js/162.f321f983.js"><link rel="prefetch" href="/assets/js/163.f427055c.js"><link rel="prefetch" href="/assets/js/164.011a4165.js"><link rel="prefetch" href="/assets/js/165.fb04e357.js"><link rel="prefetch" href="/assets/js/166.22aa118b.js"><link rel="prefetch" href="/assets/js/167.9b3a7654.js"><link rel="prefetch" href="/assets/js/168.809a29e6.js"><link rel="prefetch" href="/assets/js/169.5ad4e8f0.js"><link rel="prefetch" href="/assets/js/17.86bc7706.js"><link rel="prefetch" href="/assets/js/170.aec3fd57.js"><link rel="prefetch" href="/assets/js/171.32dbd986.js"><link rel="prefetch" href="/assets/js/172.601575f2.js"><link rel="prefetch" href="/assets/js/173.52dd154d.js"><link rel="prefetch" href="/assets/js/174.5ba6300a.js"><link rel="prefetch" href="/assets/js/175.2f89e69b.js"><link rel="prefetch" href="/assets/js/176.9dc0eac7.js"><link rel="prefetch" href="/assets/js/177.1c365624.js"><link rel="prefetch" href="/assets/js/178.91caba05.js"><link rel="prefetch" href="/assets/js/179.9c911a6e.js"><link rel="prefetch" href="/assets/js/18.cd87a72e.js"><link rel="prefetch" href="/assets/js/180.80655cbf.js"><link rel="prefetch" href="/assets/js/181.ed85d983.js"><link rel="prefetch" href="/assets/js/182.1e17fc78.js"><link rel="prefetch" href="/assets/js/183.02acffe6.js"><link rel="prefetch" href="/assets/js/184.9243297f.js"><link rel="prefetch" href="/assets/js/185.f8354684.js"><link rel="prefetch" href="/assets/js/186.d7462eed.js"><link rel="prefetch" href="/assets/js/187.26d2f0ca.js"><link rel="prefetch" href="/assets/js/188.5b1aa9be.js"><link rel="prefetch" href="/assets/js/189.d054804a.js"><link rel="prefetch" href="/assets/js/19.910fc8d0.js"><link rel="prefetch" href="/assets/js/190.c79e4c7b.js"><link rel="prefetch" href="/assets/js/191.190bbaf4.js"><link rel="prefetch" href="/assets/js/192.d0f08b9f.js"><link rel="prefetch" href="/assets/js/193.65076ebc.js"><link rel="prefetch" href="/assets/js/194.79a28f24.js"><link rel="prefetch" href="/assets/js/195.c3db4ae0.js"><link rel="prefetch" href="/assets/js/196.922f01f4.js"><link rel="prefetch" href="/assets/js/197.72fc5f68.js"><link rel="prefetch" href="/assets/js/198.3e9c7e4c.js"><link rel="prefetch" href="/assets/js/199.7c704dea.js"><link rel="prefetch" href="/assets/js/20.f2e93d17.js"><link rel="prefetch" href="/assets/js/200.8746331d.js"><link rel="prefetch" href="/assets/js/201.4698882a.js"><link rel="prefetch" href="/assets/js/202.0a8a7594.js"><link rel="prefetch" href="/assets/js/203.64f9b437.js"><link rel="prefetch" href="/assets/js/204.d6f38f7a.js"><link rel="prefetch" href="/assets/js/205.7866d898.js"><link rel="prefetch" href="/assets/js/206.9b24367e.js"><link rel="prefetch" href="/assets/js/207.2fb62ef6.js"><link rel="prefetch" href="/assets/js/208.8a29c442.js"><link rel="prefetch" href="/assets/js/21.8afea724.js"><link rel="prefetch" href="/assets/js/22.16b7f426.js"><link rel="prefetch" href="/assets/js/23.b4e38d6f.js"><link rel="prefetch" href="/assets/js/24.d54f4334.js"><link rel="prefetch" href="/assets/js/25.2d1f0877.js"><link rel="prefetch" href="/assets/js/26.d1bfb1b7.js"><link rel="prefetch" href="/assets/js/27.0610f28c.js"><link rel="prefetch" href="/assets/js/28.f1b496e3.js"><link rel="prefetch" href="/assets/js/29.08e9944c.js"><link rel="prefetch" href="/assets/js/3.970a66a4.js"><link rel="prefetch" href="/assets/js/30.ae297928.js"><link rel="prefetch" href="/assets/js/31.4fd0d93b.js"><link rel="prefetch" href="/assets/js/32.44966b63.js"><link rel="prefetch" href="/assets/js/33.eb167d44.js"><link rel="prefetch" href="/assets/js/34.295422ff.js"><link rel="prefetch" href="/assets/js/35.2c5a0b70.js"><link rel="prefetch" href="/assets/js/36.fddd48a5.js"><link rel="prefetch" href="/assets/js/37.367a54b5.js"><link rel="prefetch" href="/assets/js/38.77ea2014.js"><link rel="prefetch" href="/assets/js/39.18b0acf7.js"><link rel="prefetch" href="/assets/js/40.ee22aa00.js"><link rel="prefetch" href="/assets/js/41.8b43745c.js"><link rel="prefetch" href="/assets/js/42.66bb07f8.js"><link rel="prefetch" href="/assets/js/43.636bf8a8.js"><link rel="prefetch" href="/assets/js/44.b341b996.js"><link rel="prefetch" href="/assets/js/45.d885e19e.js"><link rel="prefetch" href="/assets/js/46.7e4d0e2f.js"><link rel="prefetch" href="/assets/js/47.3bc4cde3.js"><link rel="prefetch" href="/assets/js/48.4ee9fba2.js"><link rel="prefetch" href="/assets/js/49.14783870.js"><link rel="prefetch" href="/assets/js/5.d1da013e.js"><link rel="prefetch" href="/assets/js/50.13c266ab.js"><link rel="prefetch" href="/assets/js/51.4318da19.js"><link rel="prefetch" href="/assets/js/52.7c9cc18f.js"><link rel="prefetch" href="/assets/js/53.378b5732.js"><link rel="prefetch" href="/assets/js/54.e47e03a7.js"><link rel="prefetch" href="/assets/js/55.ee80e16b.js"><link rel="prefetch" href="/assets/js/56.e14027f4.js"><link rel="prefetch" href="/assets/js/57.b3cb8ffb.js"><link rel="prefetch" href="/assets/js/58.eb09f34e.js"><link rel="prefetch" href="/assets/js/59.a537c130.js"><link rel="prefetch" href="/assets/js/6.9bdf2d86.js"><link rel="prefetch" href="/assets/js/60.25c48265.js"><link rel="prefetch" href="/assets/js/61.8653aa8c.js"><link rel="prefetch" href="/assets/js/62.69bb406d.js"><link rel="prefetch" href="/assets/js/63.4e7c77ba.js"><link rel="prefetch" href="/assets/js/64.ecda83e6.js"><link rel="prefetch" href="/assets/js/65.55a0ff6e.js"><link rel="prefetch" href="/assets/js/66.ed942689.js"><link rel="prefetch" href="/assets/js/67.6f7c9f8c.js"><link rel="prefetch" href="/assets/js/68.006a7e36.js"><link rel="prefetch" href="/assets/js/69.574000ec.js"><link rel="prefetch" href="/assets/js/7.9ac2367b.js"><link rel="prefetch" href="/assets/js/70.e3b758e6.js"><link rel="prefetch" href="/assets/js/71.4d8bdcb1.js"><link rel="prefetch" href="/assets/js/72.c2526cec.js"><link rel="prefetch" href="/assets/js/73.d791feee.js"><link rel="prefetch" href="/assets/js/74.5973a4fb.js"><link rel="prefetch" href="/assets/js/75.69a97303.js"><link rel="prefetch" href="/assets/js/76.6241dd05.js"><link rel="prefetch" href="/assets/js/77.cc95848f.js"><link rel="prefetch" href="/assets/js/78.bf5853c2.js"><link rel="prefetch" href="/assets/js/79.6ca3cd68.js"><link rel="prefetch" href="/assets/js/8.6b13a443.js"><link rel="prefetch" href="/assets/js/80.db3dafc8.js"><link rel="prefetch" href="/assets/js/81.c48160c5.js"><link rel="prefetch" href="/assets/js/82.8c1c51fe.js"><link rel="prefetch" href="/assets/js/83.76256fe7.js"><link rel="prefetch" href="/assets/js/84.ba6c380e.js"><link rel="prefetch" href="/assets/js/85.71c3233e.js"><link rel="prefetch" href="/assets/js/86.fe0ed2a2.js"><link rel="prefetch" href="/assets/js/87.d7dca667.js"><link rel="prefetch" href="/assets/js/88.d7051ae9.js"><link rel="prefetch" href="/assets/js/89.ceed231e.js"><link rel="prefetch" href="/assets/js/90.cb5b9f7e.js"><link rel="prefetch" href="/assets/js/91.186b87b4.js"><link rel="prefetch" href="/assets/js/92.09574fb8.js"><link rel="prefetch" href="/assets/js/93.d159420a.js"><link rel="prefetch" href="/assets/js/94.59ad6229.js"><link rel="prefetch" href="/assets/js/95.06d1a88d.js"><link rel="prefetch" href="/assets/js/96.8ac1aaf0.js"><link rel="prefetch" href="/assets/js/97.b6ad2632.js"><link rel="prefetch" href="/assets/js/98.9157217b.js"><link rel="prefetch" href="/assets/js/99.c25b229f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef35a4d2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/author/" class="nav-link">Author</a></div><div class="nav-item"><a href="/articles/" class="nav-link">Blog</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Using Azure Key Vault to manage your secrets</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/dotnet-keyvault.html#why-use-it" class="sidebar-link">Why use it</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-keyvault.html#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-keyvault.html#authenticating-to-key-vault" class="sidebar-link">Authenticating to Key Vault</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#permissions" class="sidebar-link">Permissions</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#have-a-safe-behavior" class="sidebar-link">Have a safe behavior</a></li></ul></li><li><a href="/pages/dotnet-keyvault.html#demo-create-a-key-vault-store-and-read-a-secret" class="sidebar-link">DEMO, create a Key Vault store and read a secret</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-keyvault.html#demo-reading-a-secret-from-your-code-when-developing" class="sidebar-link">DEMO, Reading a secret from your code, when developing</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/dotnet-keyvault.html#demo-reading-a-secret-from-code-when-deployed" class="sidebar-link">DEMO, reading a secret from code, when deployed</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#rebuild-to-an-api" class="sidebar-link">Rebuild to an API</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#create-the-web-app" class="sidebar-link">Create the web app</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#authenticate-via-a-principal" class="sidebar-link">Authenticate via a principal</a></li><li class="sidebar-sub-header"><a href="/pages/dotnet-keyvault.html#deploy-the-app" class="sidebar-link">Deploy the app</a></li></ul></li><li><a href="/pages/dotnet-keyvault.html#summary" class="sidebar-link">Summary</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><img src="https://dev-to-uploads.s3.amazonaws.com/i/bpsi8poexuej51yjbvbk.jpg" alt=""></p> <p>TLDR; this article tells you why you should use Azure KeyVault to store and manage your secrets. Furthermore it takes you all the way from local development to deployed on Azure (there are some differences in how to authenticate).</p> <p>Azure Key Vault service is a service on Azure. It's a vault for your secrets that is encrypted. It solves the following problems:</p> <ul><li><strong>Secrets Management</strong> - Azure Key Vault can be used to Securely store and tightly control access to tokens, passwords, certificates, API keys, and other secrets.</li> <li><strong>Key Management</strong> - Azure Key Vault can also be used as a Key Management solution. Azure Key Vault makes it easy to create and control the encryption keys used to encrypt your data.</li> <li><strong>Certificate Management</strong> - Azure Key Vault is also a service that lets you easily provision, manage, and deploy public and private Transport Layer Security/Secure Sockets Layer (TLS/SSL) certificates for use with Azure and your internal connected resources.</li></ul> <h2 id="why-use-it"><a href="#why-use-it" aria-hidden="true" class="header-anchor">#</a> Why use it</h2> <p>Key Vault greatly reduces the chances that secrets may be accidentally leaked. There's also some additional benefits such as:</p> <ul><li><p><strong>Secrets are separate from code</strong> Application developers no longer need to store security information in their application.</p></li> <li><p><strong>Access via URIs</strong>. Your applications can securely access the information they need by using URIs. These URIs allow the applications to retrieve specific versions of a secret.</p></li> <li><p><strong>No need for custom code</strong>. There is no need to write custom code to protect any of the secret information stored in Key Vault.</p></li> <li><p><strong>Monitoring</strong>, you can enable logging for your Vaults. You can configure the monitoring to:</p> <ul><li>Archive to a storage account.</li> <li>Stream to an event hub.</li> <li>Send the logs to Azure Monitor logs</li></ul></li> <li><p><strong>Authentication via AAD, Azure active directory</strong>. Access to a Key Vault requires proper authentication and authorization. Authentication is done via Azure Active Directory.</p></li> <li><p><strong>Two ways to authorize</strong>. Authorization may be done via Azure role-based access control (Azure RBAC) or Key Vault access policy</p></li></ul> <h2 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h2> <ul><li><p><a href="https://docs.microsoft.com/en-us/learn/modules/manage-secrets-with-azure-key-vault?WT.mc_id=academic-12792-chnoring" target="_blank" rel="noopener noreferrer">Learn module Azure Key Vault<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. If you are completely new to Key Vault this is the best place to start. It takes you through explaining what Key Vault is, what to use it for. How to run something locally and how to deploy it to the cloud.</p></li> <li><p><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/overview#securely-store-secrets-and-keys?WT.mc_id=academic-12792-chnoring" target="_blank" rel="noopener noreferrer">More on auth<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://docs.microsoft.com/en-us/azure/key-vault/secrets/quick-create-node?WT.mc_id=academic-12792-chnoring" target="_blank" rel="noopener noreferrer">Quickstart Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> This is a quickstart that tells you how to work with secrets locally using Node.js. Great no-nonsense guide if you want to get started quickly.</p></li> <li><p><a href="https://docs.microsoft.com/en-us/previous-versions/azure/key-vault/quick-create-net-v3?WT.mc_id=academic-12792-chnoring" target="_blank" rel="noopener noreferrer">Quickstart .NET<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> A good quick start article showing how to create a Key Vault, use the .NET SDK and a service principal to authenticate.</p></li> <li><p><a href="https://docs.microsoft.com/en-us/azure/key-vault/secrets/about-secrets?WT.mc_id=academic-12792-chnoring" target="_blank" rel="noopener noreferrer">KeyVault secrets<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Good page that gives more of an understanding of how secrets are stored and what different permission levels exist among other things.</p></li></ul> <h2 id="authenticating-to-key-vault"><a href="#authenticating-to-key-vault" aria-hidden="true" class="header-anchor">#</a> Authenticating to Key Vault</h2> <p>An important thing to realize when you want to read from the Key Vault within an app is that you need two different approaches depending on whether you are developing locally, or you have deployed the app to Azure. Why is that?</p> <p>Let's explain the two different situations:</p> <ul><li><p><strong>In development locally</strong>, you can be authenticated by using either Azure CLI and the <code>az login</code> command. You can also use the Azure extension for VS Code and log in to Azure that way. What happens when you use either of those methods a credential is created on your machine. If you then use the official SDKs for your chosen platform, it will be able to authenticate using said credential.</p></li> <li><p><strong>When deployed on Azure</strong>. To reiterate, your code will most likely use an SDK for a supported language platform like .NET, Node.js, Python etc. Now, the SDK works for you in both when developing locally and deployed to Azure. It looks for credentials in many places like Az CLI and Visual Studio Code as we've already mentioned. However, once deployed, your app has access to neither of those two, so what does it do? It uses either environment variables (in App Settings for example) or it uses a so called <em>managed identity</em> to authenticate.</p> <p>A managed identity is an <em>impersonated</em> identity you can create, either based on your service (a web app for example) or based on your user. What you do is to run a command, with either your user or your app as an argument, and back comes an identity and a secret. Here's an example of how you can create such an identity:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az webapp identity assign \
 --resource-group <span class="token string">&quot;&lt;resource group name&gt;&quot;</span> \
 --name <span class="token string">&quot;&lt;your-unique-app-name&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The above command returns a principal id that you will use as an argument in the next command. Once you have that identity created you need to assign it to the Key Vault using <code>az keyvault set policy</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault set-policy \
 --secret-permissions get list \
 --name <span class="token string">&quot;&lt;your-unique-vault-name&gt;&quot;</span> \
 --object-id <span class="token string">&quot;&lt;your-managed-identity-principalid&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>After that, you are ready to deploy your app to Azure and Azure Active Directory will authenticate your app and let you read from the Key Vault. This will all be shown in detail further down in the article, but now you know roughly what goes on.</p></li></ul> <h3 id="permissions"><a href="#permissions" aria-hidden="true" class="header-anchor">#</a> Permissions</h3> <p>The <code>set-policy</code> command above not only associates your identity to the Key Vault, it also sets permissions. The argument <code>--secret-permissions</code> contains a list of permissions that determines if you are able to read, write and manage secrets. Be as restrictive as you can who can do what with your Key Vault.  In general, I reason like this when it comes to permissions:</p> <ul><li><strong>Read, for most apps</strong>. Most apps only need to read a secret.</li> <li><strong>Write, only when absolutely needed</strong>. Apps or users that needs this access is some kind of admin. Either the app manages secrets via a web API for example or there's an admin user that some other way needs to do something advanced to the secrets.</li></ul> <h3 id="have-a-safe-behavior"><a href="#have-a-safe-behavior" aria-hidden="true" class="header-anchor">#</a> Have a safe behavior</h3> <p>Even though Key Vault helps you keep your secrets secure, it can still leak if you're not careful. You don't want to ever show the value of a secret on a web page or as part of an error. What you can do, is to have a safe behavior and ensure you do things such as:</p> <ul><li><strong>Be restrictive with permissions</strong>, if your app only needs to read a secret, don't give it permission to SET, DELETE or do something else.</li> <li><strong>Rotate keys</strong>, you can change the values of the keys/secrets. The apps using those keys won't be affected as they only operate on they keys name, not its value.</li></ul> <h2 id="demo-create-a-key-vault-store-and-read-a-secret"><a href="#demo-create-a-key-vault-store-and-read-a-secret" aria-hidden="true" class="header-anchor">#</a> DEMO, create a Key Vault store and read a secret</h2> <p>Next, you will be taken through a series of steps where you will get to do the following:</p> <ul><li><strong>Create a KeyVault</strong>, you will create a Key Vault from the command line using Azure CLI</li> <li><strong>You will add secrets</strong>, to the Key Vault and ensure you can read back the value using Node.js and some SDK libraries.</li> <li><strong>Create an assign identity</strong>, you will then create a managed identity, using your web app as an argument and assign to the Key Vault</li> <li><strong>Deploy app</strong>, once you have all these parts in place, you will deploy the app and see that it can still read secrets from the Key Vault.</li></ul> <p>To create a Key Vault, follow these steps:</p> <ol><li><p><strong>Login to Azure.</strong> In a terminal type <code>az login</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az login
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Select the user you want to login with.</p></li> <li><p><strong>Create a resource group.</strong> You may use an existing resource group at this point, but if you want to create a new one, type the following:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az group create --name <span class="token string">&quot;&lt;a name for resource group&gt;&quot;</span> -l <span class="token string">&quot;EastUS&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Create the Key Vault</strong>. Run the <code>az keyvault</code> command below:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault create --name <span class="token string">&quot;&lt;unique vault name&gt;&quot;</span> --resource-group <span class="token string">&quot;keyvaultrg&quot;</span> --location <span class="token string">&quot;EastUS&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Create a secret</strong>, using the following command <code>az keyvault secret set</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault secret <span class="token keyword">set</span> --vault-name <span class="token string">&quot;&lt;unique vault name&gt;&quot;</span> --name <span class="token string">&quot;mySecret&quot;</span> --value <span class="token string">&quot;abc123&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Read the secret</strong>, from the vault by running this command <code>az keyvault secret show</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault secret show --vault-name<span class="token operator">=</span><span class="token string">&quot;&lt;unique vault name&gt;&quot;</span> --name<span class="token operator">=</span><span class="token string">&quot;mySecret&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h2 id="demo-reading-a-secret-from-your-code-when-developing"><a href="#demo-reading-a-secret-from-your-code-when-developing" aria-hidden="true" class="header-anchor">#</a> DEMO, Reading a secret from your code, when developing</h2> <p>There's SDKs for most major platforms. I'll be selecting the Node.js one for this demo. If you want the C# one you can select this language pivot:</p> <blockquote><p><a href="https://docs.microsoft.com/en-us/learn/modules/manage-secrets-with-azure-key-vault/5-access-secrets-from-web-app?pivots=csharp" target="_blank" rel="noopener noreferrer">C# KeyVault SDK<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <ol><li><p>Run the command <code>az login</code> to ensure you are logged into Azure before proceeding. This will place a credential on your machine that the SDK will be able to pick up.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az login
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Select the Azure user that you want and then close the browser windows when asked.</p></li> <li><p>Create a file <em>app.js</em></p></li> <li><p>Instantiate a Node.js project by running the <code>npm init</code> command like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm init <span class="token operator">-</span>y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>Download the needed SDK libraries from npm using the <code>npm install</code> command like so:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>npm install @azure<span class="token operator">/</span>identity @azure<span class="token operator">/</span>keyvault<span class="token operator">-</span>secrets dotenv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>dotenv</code> is not part of the SDK, it just let's us define some environment variables in a <em>.env</em> file and they get read to the env variables at initialization.</p></li> <li><p><strong>Add imports</strong>. Open <em>app.js</em> and add the following two lines at the top:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> DefaultAzureCredential <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@azure/identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SecretClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@azure/keyvault-secrets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The first line ensures values from the <em>.env</em> file is read in. Given the upcoming code the content of <em>.env</em> file should look something like this:</p> <div class="language-output line-numbers-mode"><pre class="language-text"><code>VAULT_NAME=&lt;key vault value, change me&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Instantiate a client</strong>. We do that with the following lines of code:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> secretName <span class="token operator">=</span> <span class="token string">&quot;mySecret&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> keyVaultName <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&quot;VAULT_NAME&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> KVUri <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> keyVaultName <span class="token operator">+</span> <span class="token string">&quot;.vault.azure.net&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> credential <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAzureCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretClient</span><span class="token punctuation">(</span>KVUri<span class="token punctuation">,</span> credential<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Note how the first two lines help construct the URL to the Key Vault given it's name, that it reads from <code>VAULT_NAME</code> variable from our <em>.env</em> file. Next an instantiation of <code>DefaultAzureCredential</code> is done. This instance will find the credential produced by <code>az login</code>.</p> <blockquote><p>NOTE, we will need to change how this authentication happens once we deploy the app, but this works for now.</p></blockquote></li> <li><p><strong>Retrieve secrets value</strong>. Lastly, we add code retrieve the value of the secret:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> retrievedSecret <span class="token operator">=</span> <span class="token keyword">await</span> 
 client<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span>secretName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>retrievedSecret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p><strong>Add npm &quot;start&quot; command</strong>. Add an entry to <em>package.json</em> and the script section:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node app.js&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Run the app</strong>, by typing the following in the console:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>This should give you a response looking something like this:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  value<span class="token punctuation">:</span> <span class="token string">'abc123'</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> <span class="token string">'mySecret'</span><span class="token punctuation">,</span>
  properties<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    expiresOn<span class="token punctuation">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    createdOn<span class="token punctuation">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">11</span>T18<span class="token punctuation">:</span><span class="token number">06</span><span class="token punctuation">:</span><span class="token number">19.000</span>Z<span class="token punctuation">,</span>
    updatedOn<span class="token punctuation">:</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">11</span>T18<span class="token punctuation">:</span><span class="token number">06</span><span class="token punctuation">:</span><span class="token number">19.000</span>Z<span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token string">'abc123'</span><span class="token punctuation">,</span>
    id<span class="token punctuation">:</span> <span class="token string">'https://&lt;key vault name&gt;.vault.azure.net/secrets/mySecret/&lt;the secret&gt;'</span><span class="token punctuation">,</span>
   tags<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">'file-encoding'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   vaultUrl<span class="token punctuation">:</span> <span class="token string">'https://&lt;key vault name&gt;.vault.azure.net'</span><span class="token punctuation">,</span>
   name<span class="token punctuation">:</span> <span class="token string">'mySecret'</span><span class="token punctuation">,</span>
   version<span class="token punctuation">:</span> <span class="token string">'&lt;version&gt;'</span><span class="token punctuation">,</span>
   enabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   recoverableDays<span class="token punctuation">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
   recoveryLevel<span class="token punctuation">:</span> <span class="token string">'Recoverable+Purgeable'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>You can see that you are able to successfully retrieve the value of your secret from the Key Vault and via code. Great, congrats.</p></li></ol> <h2 id="demo-reading-a-secret-from-code-when-deployed"><a href="#demo-reading-a-secret-from-code-when-deployed" aria-hidden="true" class="header-anchor">#</a> DEMO, reading a secret from code, when deployed</h2> <p>As we are looking to deploy our app next, there are two things we need to do:</p> <ul><li><strong>Rebuild to an API</strong>. Ensure we rebuild the app to a web API, we will use Express framework for this</li> <li><strong>Authenticate via a principal</strong>. We will need to perform the following steps for that:
<ol><li>Create a webapp on Azure.</li> <li>Create a principal, using the name of the app as an arg.</li> <li>Associate the principal to the Key Vault.</li></ol></li> <li><strong>Deploy the app</strong>. That's something we can do via the command line.</li></ul> <h3 id="rebuild-to-an-api"><a href="#rebuild-to-an-api" aria-hidden="true" class="header-anchor">#</a> Rebuild to an API</h3> <p>First, we will need to rebuild the app to Express. We do this just so we can interact with the app once deployed. We will display the value of the secret.</p> <blockquote><p>Don't do this in a real scenario, this is just to show that we have the proper access to the Key Vault.</p></blockquote> <ol><li><p><strong>Install web framework</strong>. Install express using <code>npm install</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> express
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>Add route</strong>. Ensure you have <em>app.js</em> open and change the code to the following:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// this is not needed when deployed</span>
<span class="token comment">// require('dotenv').config()</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> DefaultAzureCredential <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@azure/identity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SecretClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@azure/keyvault-secrets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> keyVaultName <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">&quot;VAULT_NAME&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> KVUri <span class="token operator">=</span> <span class="token string">&quot;https://&quot;</span> <span class="token operator">+</span> keyVaultName <span class="token operator">+</span> <span class="token string">&quot;.vault.azure.net&quot;</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> credential <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAzureCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretClient</span><span class="token punctuation">(</span>KVUri<span class="token punctuation">,</span> credential<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">const</span> secretName <span class="token operator">=</span> <span class="token string">&quot;mySecret&quot;</span><span class="token punctuation">;</span>
 
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/test'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> retrievedSecret <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span>secretName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> retrievedSecret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li></ol> <p>What we have now is an express app with a route to <code>/api/test</code>.</p> <ol><li><strong>Test your program</strong>, by running <code>npm start</code> in the console. In the browser, navigate to <code>http://localhost:3000/api/test</code>. It should show your secret as a JSON response.</li></ol> <h3 id="create-the-web-app"><a href="#create-the-web-app" aria-hidden="true" class="header-anchor">#</a> Create the web app</h3> <p>Because we plan to deploy this on Azure we need to make sure our app properly authenticates to Azure AD and that the Key Vault is ok with us reading from it. There's just a few steps to make that happen:</p> <ol><li><p><strong>Create a service plan</strong>, first need a service plan. Run the command <code>az appservice plan create</code>, like so:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az appservice plan create \
 --name <span class="token string">&quot;&lt;unique service plan name for your subscription&gt;&quot;</span> \
 --sku FREE \
 --location centralus \
 --resource-group <span class="token string">&quot;&lt;existing resource group&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p><strong>Create a web app</strong>, we need to create web app first as we will use it's name as an argument when we create a so called principal. Run <code>az webapp create</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az webapp create \
 --plan <span class="token string">&quot;&lt;unique service plan name for your subscription&gt;&quot;</span> \
 --runtime <span class="token string">&quot;node|10.6&quot;</span> \
 --resource-group <span class="token string">&quot;&lt;existing resource group&gt;&quot;</span> \
 --name <span class="token string">&quot;&lt;unique app name&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p><strong>Create the app settings</strong>, next configure the app setting on the web app by calling <code>az webapp config appsettings set</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az webapp config appsettings <span class="token keyword">set</span> \
 --resource-group <span class="token string">&quot;&lt;existing resource group&gt;&quot;</span> \
 --name <span class="token string">&quot;&lt;unique app name&gt;&quot;</span> \
 --settings <span class="token string">'VAULT_NAME=&lt;your-unique-vault-name&gt;'</span> <span class="token string">'SCM_DO_BUILD_DURING_DEPLOYMENT=true'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The command above will ensure that <code>process.env['VAULT_NAME']</code> will get populated once deployed. Also we no longer need the <code>dotenv</code> lib to read from the <em>.env</em> file.</p></li></ol> <h3 id="authenticate-via-a-principal"><a href="#authenticate-via-a-principal" aria-hidden="true" class="header-anchor">#</a> Authenticate via a principal</h3> <p>There are two things that needs doing. Creating the impersonated identity and assigning the identity to the Key Vault, and in doing so give the needed permissions to be able to read the secrets values.</p> <ol><li><p><strong>Create a service principal</strong>, run the command <code>az webapp identity assign</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az webapp identity assign \
 --resource-group <span class="token string">&quot;&lt;existing resource group&gt;&quot;</span> \
 --name <span class="token string">&quot;&lt;unique app name&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This will produce a JSON response that contains a field <strong>principalId</strong>. You will use that in the next command to associate an identity with a Key Vault, while adding a set of permissions.</p></li> <li><p><strong>Grant permission to the Key Vault</strong>, run the command <code>az keyvault set-policy</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>az keyvault set-policy \
 --secret-permissions get list \
 --name <span class="token string">&quot;&lt;your-unique-vault-name&gt;&quot;</span> \
 --object-id <span class="token string">&quot;&lt;principalId&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Here we can see how we assign <code>get</code> and <code>list</code> as permissions for our identity, when it gets associated to the Key Vault. That's what's needed for the app to be able to read from the Key Vault.</p> <blockquote><p>We would have needed another set of permissions if we wanted to create or delete a secret for example.</p></blockquote></li></ol> <h3 id="deploy-the-app"><a href="#deploy-the-app" aria-hidden="true" class="header-anchor">#</a> Deploy the app</h3> <p>To deploy the app, there's only one command we need to run. All that's needed is to compress the application and deploy it.</p> <ul><li><p><strong>Deploy the app</strong>. As a final step, deploy the app using the command:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">zip</span> site.zip * -x node_modules/

az webapp deployment <span class="token function">source</span> config-zip \
 --src site.zip \
 --resource-group <span class="token string">&quot;&lt;existing resource group&gt;&quot;</span> \
 --name <span class="token string">&quot;&lt;unique app name&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The above command will pack up all your files, <em>node_modules</em> excluded, into a file <em>site.zip</em>. Then the files are deployed. A few minutes later you will app your app up and running and your Key Vault showing the value of your secret <strong>mySecret</strong> if you navigate to <strong>deployedUrl/api/test</strong></p></li></ul> <h2 id="summary"><a href="#summary" aria-hidden="true" class="header-anchor">#</a> Summary</h2> <p>This article was somewhat long, but it did tell you why you should use the Azure Key Vault service. It also told you how to work with the Key Vault in local development and finally how you needed to change your source code and thereby prepare it for deployment. I hope it was helpful.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.db3c62db.js" defer></script><script src="/assets/js/9.454b5262.js" defer></script><script src="/assets/js/4.eac68367.js" defer></script><script src="/assets/js/156.3b2b9b5f.js" defer></script>
  </body>
</html>
