(window.webpackJsonp=window.webpackJsonp||[]).push([[156],{397:function(e,t,s){"use strict";s.r(t);var a=s(1),n=Object(a.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[s("img",{attrs:{src:"https://dev-to-uploads.s3.amazonaws.com/i/bpsi8poexuej51yjbvbk.jpg",alt:""}})]),e._v(" "),s("p",[e._v("TLDR; this article tells you why you should use Azure KeyVault to store and manage your secrets. Furthermore it takes you all the way from local development to deployed on Azure (there are some differences in how to authenticate).")]),e._v(" "),s("p",[e._v("Azure Key Vault service is a service on Azure. It's a vault for your secrets that is encrypted. It solves the following problems:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Secrets Management")]),e._v(" - Azure Key Vault can be used to Securely store and tightly control access to tokens, passwords, certificates, API keys, and other secrets.")]),e._v(" "),s("li",[s("strong",[e._v("Key Management")]),e._v(" - Azure Key Vault can also be used as a Key Management solution. Azure Key Vault makes it easy to create and control the encryption keys used to encrypt your data.")]),e._v(" "),s("li",[s("strong",[e._v("Certificate Management")]),e._v(" - Azure Key Vault is also a service that lets you easily provision, manage, and deploy public and private Transport Layer Security/Secure Sockets Layer (TLS/SSL) certificates for use with Azure and your internal connected resources.")])]),e._v(" "),s("h2",{attrs:{id:"why-use-it"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#why-use-it","aria-hidden":"true"}},[e._v("#")]),e._v(" Why use it")]),e._v(" "),s("p",[e._v("Key Vault greatly reduces the chances that secrets may be accidentally leaked. There's also some additional benefits such as:")]),e._v(" "),s("ul",[s("li",[s("p",[s("strong",[e._v("Secrets are separate from code")]),e._v(" Application developers no longer need to store security information in their application.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Access via URIs")]),e._v(". Your applications can securely access the information they need by using URIs. These URIs allow the applications to retrieve specific versions of a secret.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("No need for custom code")]),e._v(". There is no need to write custom code to protect any of the secret information stored in Key Vault.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Monitoring")]),e._v(", you can enable logging for your Vaults. You can configure the monitoring to:")]),e._v(" "),s("ul",[s("li",[e._v("Archive to a storage account.")]),e._v(" "),s("li",[e._v("Stream to an event hub.")]),e._v(" "),s("li",[e._v("Send the logs to Azure Monitor logs")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Authentication via AAD, Azure active directory")]),e._v(". Access to a Key Vault requires proper authentication and authorization. Authentication is done via Azure Active Directory.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Two ways to authorize")]),e._v(". Authorization may be done via Azure role-based access control (Azure RBAC) or Key Vault access policy")])])]),e._v(" "),s("h2",{attrs:{id:"references"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#references","aria-hidden":"true"}},[e._v("#")]),e._v(" References")]),e._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/learn/modules/manage-secrets-with-azure-key-vault?WT.mc_id=academic-12792-chnoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("Learn module Azure Key Vault"),s("OutboundLink")],1),e._v(". If you are completely new to Key Vault this is the best place to start. It takes you through explaining what Key Vault is, what to use it for. How to run something locally and how to deploy it to the cloud.")])]),e._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/key-vault/general/overview#securely-store-secrets-and-keys?WT.mc_id=academic-12792-chnoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("More on auth"),s("OutboundLink")],1)])]),e._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/key-vault/secrets/quick-create-node?WT.mc_id=academic-12792-chnoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("Quickstart Node.js"),s("OutboundLink")],1),e._v(" This is a quickstart that tells you how to work with secrets locally using Node.js. Great no-nonsense guide if you want to get started quickly.")])]),e._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/previous-versions/azure/key-vault/quick-create-net-v3?WT.mc_id=academic-12792-chnoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("Quickstart .NET"),s("OutboundLink")],1),e._v(" A good quick start article showing how to create a Key Vault, use the .NET SDK and a service principal to authenticate.")])]),e._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/key-vault/secrets/about-secrets?WT.mc_id=academic-12792-chnoring",target:"_blank",rel:"noopener noreferrer"}},[e._v("KeyVault secrets"),s("OutboundLink")],1),e._v(". Good page that gives more of an understanding of how secrets are stored and what different permission levels exist among other things.")])])]),e._v(" "),s("h2",{attrs:{id:"authenticating-to-key-vault"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authenticating-to-key-vault","aria-hidden":"true"}},[e._v("#")]),e._v(" Authenticating to Key Vault")]),e._v(" "),s("p",[e._v("An important thing to realize when you want to read from the Key Vault within an app is that you need two different approaches depending on whether you are developing locally, or you have deployed the app to Azure. Why is that?")]),e._v(" "),s("p",[e._v("Let's explain the two different situations:")]),e._v(" "),s("ul",[s("li",[s("p",[s("strong",[e._v("In development locally")]),e._v(", you can be authenticated by using either Azure CLI and the "),s("code",[e._v("az login")]),e._v(" command. You can also use the Azure extension for VS Code and log in to Azure that way. What happens when you use either of those methods a credential is created on your machine. If you then use the official SDKs for your chosen platform, it will be able to authenticate using said credential.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("When deployed on Azure")]),e._v(". To reiterate, your code will most likely use an SDK for a supported language platform like .NET, Node.js, Python etc. Now, the SDK works for you in both when developing locally and deployed to Azure. It looks for credentials in many places like Az CLI and Visual Studio Code as we've already mentioned. However, once deployed, your app has access to neither of those two, so what does it do? It uses either environment variables (in App Settings for example) or it uses a so called "),s("em",[e._v("managed identity")]),e._v(" to authenticate.")]),e._v(" "),s("p",[e._v("A managed identity is an "),s("em",[e._v("impersonated")]),e._v(" identity you can create, either based on your service (a web app for example) or based on your user. What you do is to run a command, with either your user or your app as an argument, and back comes an identity and a secret. Here's an example of how you can create such an identity:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az webapp identity assign \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<resource group name>"')]),e._v(" \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<your-unique-app-name>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("The above command returns a principal id that you will use as an argument in the next command. Once you have that identity created you need to assign it to the Key Vault using "),s("code",[e._v("az keyvault set policy")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az keyvault set-policy \\\n --secret-permissions get list \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<your-unique-vault-name>"')]),e._v(" \\\n --object-id "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<your-managed-identity-principalid>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("After that, you are ready to deploy your app to Azure and Azure Active Directory will authenticate your app and let you read from the Key Vault. This will all be shown in detail further down in the article, but now you know roughly what goes on.")])])]),e._v(" "),s("h3",{attrs:{id:"permissions"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#permissions","aria-hidden":"true"}},[e._v("#")]),e._v(" Permissions")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("set-policy")]),e._v(" command above not only associates your identity to the Key Vault, it also sets permissions. The argument "),s("code",[e._v("--secret-permissions")]),e._v(" contains a list of permissions that determines if you are able to read, write and manage secrets. Be as restrictive as you can who can do what with your Key Vault.  In general, I reason like this when it comes to permissions:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Read, for most apps")]),e._v(". Most apps only need to read a secret.")]),e._v(" "),s("li",[s("strong",[e._v("Write, only when absolutely needed")]),e._v(". Apps or users that needs this access is some kind of admin. Either the app manages secrets via a web API for example or there's an admin user that some other way needs to do something advanced to the secrets.")])]),e._v(" "),s("h3",{attrs:{id:"have-a-safe-behavior"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#have-a-safe-behavior","aria-hidden":"true"}},[e._v("#")]),e._v(" Have a safe behavior")]),e._v(" "),s("p",[e._v("Even though Key Vault helps you keep your secrets secure, it can still leak if you're not careful. You don't want to ever show the value of a secret on a web page or as part of an error. What you can do, is to have a safe behavior and ensure you do things such as:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Be restrictive with permissions")]),e._v(", if your app only needs to read a secret, don't give it permission to SET, DELETE or do something else.")]),e._v(" "),s("li",[s("strong",[e._v("Rotate keys")]),e._v(", you can change the values of the keys/secrets. The apps using those keys won't be affected as they only operate on they keys name, not its value.")])]),e._v(" "),s("h2",{attrs:{id:"demo-create-a-key-vault-store-and-read-a-secret"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#demo-create-a-key-vault-store-and-read-a-secret","aria-hidden":"true"}},[e._v("#")]),e._v(" DEMO, create a Key Vault store and read a secret")]),e._v(" "),s("p",[e._v("Next, you will be taken through a series of steps where you will get to do the following:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Create a KeyVault")]),e._v(", you will create a Key Vault from the command line using Azure CLI")]),e._v(" "),s("li",[s("strong",[e._v("You will add secrets")]),e._v(", to the Key Vault and ensure you can read back the value using Node.js and some SDK libraries.")]),e._v(" "),s("li",[s("strong",[e._v("Create an assign identity")]),e._v(", you will then create a managed identity, using your web app as an argument and assign to the Key Vault")]),e._v(" "),s("li",[s("strong",[e._v("Deploy app")]),e._v(", once you have all these parts in place, you will deploy the app and see that it can still read secrets from the Key Vault.")])]),e._v(" "),s("p",[e._v("To create a Key Vault, follow these steps:")]),e._v(" "),s("ol",[s("li",[s("p",[s("strong",[e._v("Login to Azure.")]),e._v(" In a terminal type "),s("code",[e._v("az login")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az login\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("Select the user you want to login with.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Create a resource group.")]),e._v(" You may use an existing resource group at this point, but if you want to create a new one, type the following:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az group create --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<a name for resource group>"')]),e._v(" -l "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"EastUS"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Create the Key Vault")]),e._v(". Run the "),s("code",[e._v("az keyvault")]),e._v(" command below:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az keyvault create --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique vault name>"')]),e._v(" --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"keyvaultrg"')]),e._v(" --location "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"EastUS"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Create a secret")]),e._v(", using the following command "),s("code",[e._v("az keyvault secret set")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az keyvault secret "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("set")]),e._v(" --vault-name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique vault name>"')]),e._v(" --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"mySecret"')]),e._v(" --value "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"abc123"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Read the secret")]),e._v(", from the vault by running this command "),s("code",[e._v("az keyvault secret show")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az keyvault secret show --vault-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique vault name>"')]),e._v(" --name"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"mySecret"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])])]),e._v(" "),s("h2",{attrs:{id:"demo-reading-a-secret-from-your-code-when-developing"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#demo-reading-a-secret-from-your-code-when-developing","aria-hidden":"true"}},[e._v("#")]),e._v(" DEMO, Reading a secret from your code, when developing")]),e._v(" "),s("p",[e._v("There's SDKs for most major platforms. I'll be selecting the Node.js one for this demo. If you want the C# one you can select this language pivot:")]),e._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://docs.microsoft.com/en-us/learn/modules/manage-secrets-with-azure-key-vault/5-access-secrets-from-web-app?pivots=csharp",target:"_blank",rel:"noopener noreferrer"}},[e._v("C# KeyVault SDK"),s("OutboundLink")],1)])]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Run the command "),s("code",[e._v("az login")]),e._v(" to ensure you are logged into Azure before proceeding. This will place a credential on your machine that the SDK will be able to pick up.")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az login\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("Select the Azure user that you want and then close the browser windows when asked.")])]),e._v(" "),s("li",[s("p",[e._v("Create a file "),s("em",[e._v("app.js")])])]),e._v(" "),s("li",[s("p",[e._v("Instantiate a Node.js project by running the "),s("code",[e._v("npm init")]),e._v(" command like so:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[e._v("npm init "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("y\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[e._v("Download the needed SDK libraries from npm using the "),s("code",[e._v("npm install")]),e._v(" command like so:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[e._v("npm install @azure"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("identity @azure"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("keyvault"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("secrets dotenv\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[s("code",[e._v("dotenv")]),e._v(" is not part of the SDK, it just let's us define some environment variables in a "),s("em",[e._v(".env")]),e._v(" file and they get read to the env variables at initialization.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Add imports")]),e._v(". Open "),s("em",[e._v("app.js")]),e._v(" and add the following two lines at the top:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'dotenv'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" DefaultAzureCredential "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@azure/identity"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" SecretClient "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@azure/keyvault-secrets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("The first line ensures values from the "),s("em",[e._v(".env")]),e._v(" file is read in. Given the upcoming code the content of "),s("em",[e._v(".env")]),e._v(" file should look something like this:")]),e._v(" "),s("div",{staticClass:"language-output line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("VAULT_NAME=<key vault value, change me>\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Instantiate a client")]),e._v(". We do that with the following lines of code:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" secretName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"mySecret"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" keyVaultName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"VAULT_NAME"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" KVUri "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" keyVaultName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('".vault.azure.net"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" credential "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("DefaultAzureCredential")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" client "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("SecretClient")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("KVUri"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" credential"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("Note how the first two lines help construct the URL to the Key Vault given it's name, that it reads from "),s("code",[e._v("VAULT_NAME")]),e._v(" variable from our "),s("em",[e._v(".env")]),e._v(" file. Next an instantiation of "),s("code",[e._v("DefaultAzureCredential")]),e._v(" is done. This instance will find the credential produced by "),s("code",[e._v("az login")]),e._v(".")]),e._v(" "),s("blockquote",[s("p",[e._v("NOTE, we will need to change how this authentication happens once we deploy the app, but this works for now.")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Retrieve secrets value")]),e._v(". Lastly, we add code retrieve the value of the secret:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" retrievedSecret "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" \n client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("getSecret")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("secretName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("retrievedSecret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v('Add npm "start" command')]),e._v(". Add an entry to "),s("em",[e._v("package.json")]),e._v(" and the script section:")]),e._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"start"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"node app.js"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Run the app")]),e._v(", by typing the following in the console:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" start\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("This should give you a response looking something like this:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'abc123'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'mySecret'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  properties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    expiresOn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("undefined")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    createdOn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2021")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("01")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("11")]),e._v("T18"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("06")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("19.000")]),e._v("Z"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    updatedOn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("2021")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("01")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("11")]),e._v("T18"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("06")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("19.000")]),e._v("Z"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'abc123'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'https://<key vault name>.vault.azure.net/secrets/mySecret/<the secret>'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   tags"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'file-encoding'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'utf-8'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   vaultUrl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'https://<key vault name>.vault.azure.net'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'mySecret'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'<version>'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   enabled"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   recoverableDays"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("90")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n   recoveryLevel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Recoverable+Purgeable'")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br")])]),s("p",[e._v("You can see that you are able to successfully retrieve the value of your secret from the Key Vault and via code. Great, congrats.")])])]),e._v(" "),s("h2",{attrs:{id:"demo-reading-a-secret-from-code-when-deployed"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#demo-reading-a-secret-from-code-when-deployed","aria-hidden":"true"}},[e._v("#")]),e._v(" DEMO, reading a secret from code, when deployed")]),e._v(" "),s("p",[e._v("As we are looking to deploy our app next, there are two things we need to do:")]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("Rebuild to an API")]),e._v(". Ensure we rebuild the app to a web API, we will use Express framework for this")]),e._v(" "),s("li",[s("strong",[e._v("Authenticate via a principal")]),e._v(". We will need to perform the following steps for that:\n"),s("ol",[s("li",[e._v("Create a webapp on Azure.")]),e._v(" "),s("li",[e._v("Create a principal, using the name of the app as an arg.")]),e._v(" "),s("li",[e._v("Associate the principal to the Key Vault.")])])]),e._v(" "),s("li",[s("strong",[e._v("Deploy the app")]),e._v(". That's something we can do via the command line.")])]),e._v(" "),s("h3",{attrs:{id:"rebuild-to-an-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rebuild-to-an-api","aria-hidden":"true"}},[e._v("#")]),e._v(" Rebuild to an API")]),e._v(" "),s("p",[e._v("First, we will need to rebuild the app to Express. We do this just so we can interact with the app once deployed. We will display the value of the secret.")]),e._v(" "),s("blockquote",[s("p",[e._v("Don't do this in a real scenario, this is just to show that we have the proper access to the Key Vault.")])]),e._v(" "),s("ol",[s("li",[s("p",[s("strong",[e._v("Install web framework")]),e._v(". Install express using "),s("code",[e._v("npm install")])]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" express\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Add route")]),e._v(". Ensure you have "),s("em",[e._v("app.js")]),e._v(" open and change the code to the following:")]),e._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// this is not needed when deployed")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// require('dotenv').config()")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" DefaultAzureCredential "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@azure/identity"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" SecretClient "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@azure/keyvault-secrets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" port "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[e._v("PORT")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("||")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("3000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" keyVaultName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"VAULT_NAME"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" KVUri "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://"')]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" keyVaultName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('".vault.azure.net"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" credential "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("DefaultAzureCredential")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" client "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("SecretClient")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("KVUri"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" credential"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" secretName "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"mySecret"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/api/test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" secret "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("getSecret")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n   \n   res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'text'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n   res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("secret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("getSecret")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" retrievedSecret "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("getSecret")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("secretName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" retrievedSecret"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n \napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n   console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'server running'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br")])])])]),e._v(" "),s("p",[e._v("What we have now is an express app with a route to "),s("code",[e._v("/api/test")]),e._v(".")]),e._v(" "),s("ol",[s("li",[s("strong",[e._v("Test your program")]),e._v(", by running "),s("code",[e._v("npm start")]),e._v(" in the console. In the browser, navigate to "),s("code",[e._v("http://localhost:3000/api/test")]),e._v(". It should show your secret as a JSON response.")])]),e._v(" "),s("h3",{attrs:{id:"create-the-web-app"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-the-web-app","aria-hidden":"true"}},[e._v("#")]),e._v(" Create the web app")]),e._v(" "),s("p",[e._v("Because we plan to deploy this on Azure we need to make sure our app properly authenticates to Azure AD and that the Key Vault is ok with us reading from it. There's just a few steps to make that happen:")]),e._v(" "),s("ol",[s("li",[s("p",[s("strong",[e._v("Create a service plan")]),e._v(", first need a service plan. Run the command "),s("code",[e._v("az appservice plan create")]),e._v(", like so:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az appservice plan create \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique service plan name for your subscription>"')]),e._v(" \\\n --sku FREE \\\n --location centralus \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<existing resource group>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Create a web app")]),e._v(", we need to create web app first as we will use it's name as an argument when we create a so called principal. Run "),s("code",[e._v("az webapp create")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az webapp create \\\n --plan "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique service plan name for your subscription>"')]),e._v(" \\\n --runtime "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"node|10.6"')]),e._v(" \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<existing resource group>"')]),e._v(" \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique app name>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Create the app settings")]),e._v(", next configure the app setting on the web app by calling "),s("code",[e._v("az webapp config appsettings set")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az webapp config appsettings "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("set")]),e._v(" \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<existing resource group>"')]),e._v(" \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique app name>"')]),e._v(" \\\n --settings "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'VAULT_NAME=<your-unique-vault-name>'")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'SCM_DO_BUILD_DURING_DEPLOYMENT=true'")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("The command above will ensure that "),s("code",[e._v("process.env['VAULT_NAME']")]),e._v(" will get populated once deployed. Also we no longer need the "),s("code",[e._v("dotenv")]),e._v(" lib to read from the "),s("em",[e._v(".env")]),e._v(" file.")])])]),e._v(" "),s("h3",{attrs:{id:"authenticate-via-a-principal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#authenticate-via-a-principal","aria-hidden":"true"}},[e._v("#")]),e._v(" Authenticate via a principal")]),e._v(" "),s("p",[e._v("There are two things that needs doing. Creating the impersonated identity and assigning the identity to the Key Vault, and in doing so give the needed permissions to be able to read the secrets values.")]),e._v(" "),s("ol",[s("li",[s("p",[s("strong",[e._v("Create a service principal")]),e._v(", run the command "),s("code",[e._v("az webapp identity assign")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az webapp identity assign \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<existing resource group>"')]),e._v(" \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique app name>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("p",[e._v("This will produce a JSON response that contains a field "),s("strong",[e._v("principalId")]),e._v(". You will use that in the next command to associate an identity with a Key Vault, while adding a set of permissions.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Grant permission to the Key Vault")]),e._v(", run the command "),s("code",[e._v("az keyvault set-policy")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("az keyvault set-policy \\\n --secret-permissions get list \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<your-unique-vault-name>"')]),e._v(" \\\n --object-id "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<principalId>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("Here we can see how we assign "),s("code",[e._v("get")]),e._v(" and "),s("code",[e._v("list")]),e._v(" as permissions for our identity, when it gets associated to the Key Vault. That's what's needed for the app to be able to read from the Key Vault.")]),e._v(" "),s("blockquote",[s("p",[e._v("We would have needed another set of permissions if we wanted to create or delete a secret for example.")])])])]),e._v(" "),s("h3",{attrs:{id:"deploy-the-app"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-the-app","aria-hidden":"true"}},[e._v("#")]),e._v(" Deploy the app")]),e._v(" "),s("p",[e._v("To deploy the app, there's only one command we need to run. All that's needed is to compress the application and deploy it.")]),e._v(" "),s("ul",[s("li",[s("p",[s("strong",[e._v("Deploy the app")]),e._v(". As a final step, deploy the app using the command:")]),e._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("zip")]),e._v(" site.zip * -x node_modules/\n\naz webapp deployment "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("source")]),e._v(" config-zip \\\n --src site.zip \\\n --resource-group "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<existing resource group>"')]),e._v(" \\\n --name "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<unique app name>"')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("p",[e._v("The above command will pack up all your files, "),s("em",[e._v("node_modules")]),e._v(" excluded, into a file "),s("em",[e._v("site.zip")]),e._v(". Then the files are deployed. A few minutes later you will app your app up and running and your Key Vault showing the value of your secret "),s("strong",[e._v("mySecret")]),e._v(" if you navigate to "),s("strong",[e._v("deployedUrl/api/test")])])])]),e._v(" "),s("h2",{attrs:{id:"summary"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#summary","aria-hidden":"true"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),s("p",[e._v("This article was somewhat long, but it did tell you why you should use the Azure Key Vault service. It also told you how to work with the Key Vault in local development and finally how you needed to change your source code and thereby prepare it for deployment. I hope it was helpful.")])])},[],!1,null,null,null);t.default=n.exports}}]);